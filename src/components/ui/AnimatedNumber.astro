---
// Props: value (number, required), duration (ms, optional, default 1200), suffix (string, optional)
const { value, duration = 1200, suffix = "" } = Astro.props;
---

<span
  class="animated-number"
  data-value={value}
  data-duration={duration}
  data-suffix={suffix}
  style="opacity:0"></span>

<script is:inline>
  (() => {
    const el = document.currentScript.previousElementSibling;
    if (!el) return;
    function animateNumber() {
      const target = parseInt(el.dataset.value, 10);
      const duration = parseInt(el.dataset.duration, 10) || 1200;
      const suffix = el.dataset.suffix || "";
      let start = 0;
      let startTime = null;
      function step(ts) {
        if (!startTime) startTime = ts;
        const progress = Math.min((ts - startTime) / duration, 1);
        el.textContent =
          Math.floor(progress * (target - start) + start) + suffix;
        if (progress < 1) requestAnimationFrame(step);
        else el.textContent = target + suffix;
      }
      el.style.opacity = 1;
      requestAnimationFrame(step);
    }
    if ("IntersectionObserver" in window) {
      const io = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) {
          animateNumber();
        } else {
          // Reset for replay
          el.textContent = "";
          el.style.opacity = 0;
        }
      });
      io.observe(el);
    } else {
      animateNumber();
    }
  })();
</script>

<style is:inline>
  .animated-number {
    display: inline-block;
    min-width: 2.5em;
    transition: color 0.3s;
  }
</style>
