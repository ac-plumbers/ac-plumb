---
import * as cheerio from "cheerio";
import fetch from "node-fetch";
import Text from "@components/fundations/elements/Text.astro";
import TestimonialsCard from "./global/TestimonialsCard.astro";

// Cache object
let cache = {
  reviews: [],
  lastFetched: 0, // Timestamp of the last fetch
};

// Fetch reviews from Checkatrade
const url =
  "https://www.checkatrade.com/trades/acplumbingheatingbathroomsserviceslimited/reviews";
const CACHE_DURATION = 60 * 60 * 1000; // 1 hour in milliseconds

async function fetchReviews() {
  // Check if cache is still valid
  const now = Date.now();
  if (cache.reviews.length > 0 && now - cache.lastFetched < CACHE_DURATION) {
    return cache.reviews; // Return cached reviews
  }

  // Fetch and parse reviews
  try {
    const response = await fetch(url);
    const html = await response.text();
    const $ = cheerio.load(html);

    // Extract reviews (adjust selectors based on Checkatrade's structure)
    const reviews = $("li.bg-card")
      .map((i, el) => ({
        rating: $(el).find("span.font-semibold").text().trim(), // Rating (e.g., "10")
        title: $(el).find("h3").text().trim(), // Review title
        date: $(el).find("p.text-neutral-strong").text().trim(), // Date posted
        content: $(el).find("div.line-clamp-3").text().trim(), // Review content
        location: $(el).find("span.text-neutral-strong").last().text().trim(), // Job location
      }))
      .get();

    // Update cache
    cache.reviews = reviews;
    cache.lastFetched = now;

    return reviews;
  } catch (error) {
    console.error("Error fetching reviews:", error);
    return []; // Return an empty array on error
  }
}

// Fetch reviews (with caching)
const reviews = await fetchReviews();
---

<!-- display few reviews in a bento layout with cards -->
<div class="isolate overflow-hidden bg-primary-700">
  <div class="mx-auto max-w-7xl px-6 pt-24 pb-96 text-center sm:pt-32 lg:px-8">
    <div class="mx-auto max-w-4xl">
      <Text
        variant="displayLG"
        tag="h3"
        class="font-poppins font-semibold text-accent-600"
      >
        Testimonials
      </Text>
      <Text variant="textLG" tag="p" class="mt-2 text-neutral-200">
        What our customers say about us
      </Text>
    </div>
    <div
      class="mt-16 grid grid-cols-1 gap-x-8 gap-y-10 sm:grid-cols-2 lg:grid-cols-3 xl:gap-x-12"
    >
      {
        reviews.slice(0, 6).map((review) => (
          <TestimonialsCard
            title={review.title}
            review={{
              rating: review.rating,
              content: review.content,
              date: review.date,
              location: review.location,
            }}
          />
        ))
      }
    </div>
  </div>
</div>
