---
import * as cheerio from "cheerio";
import fetch from "node-fetch";
import Text from "@components/fundations/elements/Text.astro";
import TestimonialsCard from "./global/TestimonialsCard.astro";

// Cache object (unchanged)
let cache = {
  reviews: [],
  lastFetched: 0,
};

// Fetch function (unchanged)
const url =
  "https://www.checkatrade.com/trades/acplumbingheatingbathroomsserviceslimited/reviews";

const CACHE_DURATION = import.meta.env.DEV
  ? /* 1 min in dev */
    1 * 60 * 1000 // 10 minutes in dev
  : 60 * 60 * 1000; // 1 hour in prod

async function fetchReviews() {
  // Check if cache is still valid
  const now = Date.now();
  if (cache.reviews.length > 0 && now - cache.lastFetched < CACHE_DURATION) {
    return cache.reviews;
  }

  try {
    const response = await fetch(url);
    const html = await response.text();
    const $ = cheerio.load(html);

    const reviews = $("li.bg-card")
      .map((i, el) => ({
        rating: $(el).find("span.font-semibold").text().trim(),
        title: $(el).find("h3").text().trim(),
        date: $(el).find("p.text-neutral-strong").text().trim(),
        content: $(el).find("div.line-clamp-3").text().trim(),
        location: $(el).find("span.text-neutral-strong").last().text().trim(),
      }))
      .get();

    cache.reviews = reviews;
    cache.lastFetched = now;

    return reviews;
  } catch (error) {
    console.error("Error fetching reviews:", error);
    return [];
  }
}

// Fetch reviews (with caching)
const reviews = await fetchReviews();
---

<!-- Modern Bento-Style Layout -->
<section class="relative overflow-hidden bg-neutral-50 pt-24 pb-48 sm:py-32">
  <!-- Decorative Elements -->
  <div class="absolute inset-0 overflow-hidden opacity-10">
    <div
      class="absolute -top-24 -right-20 h-64 w-64 rounded-full bg-accent-400 blur-3xl"
    >
    </div>
    <div
      class="absolute top-1/2 left-10 h-96 w-96 rounded-full bg-accent-300 blur-3xl"
    >
    </div>
  </div>

  <div class="relative mx-auto max-w-7xl px-6 lg:px-8">
    <!-- Header -->
    <div class="mx-auto mb-20 max-w-2xl text-center">
      <p
        class="text-base font-semibold tracking-wide text-accent-400 uppercase"
      >
        Customer Stories
      </p>
      <Text
        tag="h2"
        variant="displayXL"
        class="mt-2 font-poppins font-bold text-balance text-text-00"
      >
        What our clients say
      </Text>
      <p class="mt-6 text-lg leading-8 text-text-00">
        Discover why our customers trust us for their plumbing and heating needs
      </p>
    </div>

    <!-- Testimonials Grid -->
    <div class="relative">
      <!-- Modern Grid Layout with Staggered Items -->
      <div
        class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 lg:gap-8"
      >
        {
          reviews.slice(0, 6).map((review, index) => (
            <div
              class={`${
                index === 0
                  ? "md:col-span-2 md:row-span-1"
                  : index === 3
                    ? "lg:col-span-2 lg:row-span-1"
                    : ""
              }`}
            >
              <TestimonialsCard
                title={review.title}
                review={{
                  rating: review.rating,
                  content: review.content,
                  date: review.date,
                  location: review.location,
                }}
              />
            </div>
          ))
        }
      </div>
    </div>

    <!-- Call to Action -->
    <div class="mt-20 text-center">
      <a
        href="https://www.checkatrade.com/trades/acplumbingheatingbathroomsserviceslimited/reviews"
        class="inline-flex items-center rounded-full bg-white px-6 py-2.5 text-base font-semibold text-primary-700 shadow-sm transition-colors duration-200 hover:bg-neutral-100 focus:ring-2 focus:ring-primary-400 focus:outline-none"
        target="_blank"
        rel="noopener noreferrer"
      >
        Read all reviews
        <svg
          class="ml-2 h-5 w-5"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
        </svg>
      </a>
    </div>
  </div>
</section>
