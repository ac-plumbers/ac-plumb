---
import Favicons from './Favicons.astro';
import AstroSchema from '@/components/fundations/head/Schema.astro';
import Meta from './Meta.astro';
import Seo from './Seo.astro';

export interface Props {
  title?: string;
  description?: string;
  keywords?: string;
  author?: string;
  themeColor?: string;
  canonical?: string;
  noindex?: boolean;
  schemaType?: string;
  datePublished?: string;
  dateModified?: string;
}

const {
  title,
  description,
  keywords,
  author,
  themeColor,
  canonical,
  noindex = true,
  schemaType = 'WebPage',
  datePublished,
  dateModified,
} = Astro.props;

// Canonical URL logic (normalize to the primary origin + strip query/hash)
// Note: make sure `site` in astro.config.mjs is set to "https://acplumb.co.uk"
const PRIMARY_ORIGIN = 'https://acplumb.co.uk';

const baseOrigin = (() => {
  // Prefer Astro.site if it exists, but always normalize to the apex primary domain.
  try {
    const site = Astro.site ? new URL(String(Astro.site)) : new URL(PRIMARY_ORIGIN);
    return new URL(PRIMARY_ORIGIN, site).origin;
  } catch {
    return new URL(PRIMARY_ORIGIN).origin;
  }s
})();

const toCanonical = (input?: string) => {
  const base = new URL(baseOrigin);

  // Build the URL (accept absolute or relative canonicals)
  const url = input
    ? new URL(input, base)
    : Astro.url
      ? new URL(Astro.url.pathname, base)
      : base;

  // Enforce https + apex host
  url.protocol = 'https:';
  url.hostname = new URL(baseOrigin).hostname;

  // Strip query/hash (avoid UTM canonicals)
  url.search = '';
  url.hash = '';

  // Normalize trailing slash for "pretty" URLs (skip files like ".xml", ".pdf", etc.)
  const lastSegment = url.pathname.split('/').filter(Boolean).pop() || '';
  const looksLikeFile = lastSegment.includes('.') && !lastSegment.endsWith('.html');
  if (!looksLikeFile && !url.pathname.endsWith('/')) url.pathname += '/';

  return url.toString();
};

const canonicalURL = toCanonical(canonical);
---

<!-- SEO with title, description, and canonical URL -->
<Seo
  title={title}
  description={description}
  canonical={canonicalURL}
  noindex={noindex}
/>

<!-- Additional meta tags (keywords, author, theme-color, etc.) -->
<Meta keywords={keywords} author={author} themeColor={themeColor} />

<!-- Schema -->
<AstroSchema
  type={schemaType}
  title={title}
  url={canonicalURL}
  description={description}
  datePublished={datePublished}
  dateModified={dateModified}
/>

<!-- Favicons -->
<Favicons />
